# ページング

## 基本概念

<img width="1197" alt="スクリーンショット 2023-06-10 18 00 51" src="https://github.com/junyaU/os_study_memo/assets/61627945/56a5c5bd-9a6e-45c4-87e3-39d6c6ab673b">

ページングは、仮想アドレス空間をページ、物理アドレス空間をフレームという固定長の区画に切り分けて、ページごとにフレームを割り当てることで、仮想アドレス空間を物理アドレス空間にマッピングする手法。\
ページのサイズは、4KiB, 2MiB, 1GiBのいずれかを選択することができる。 \
ページは、フレームに独立して割り当てることができ、物理アドレス空間に連続して配置する必要はない。

マッピングの仕方については、次に紹介するページテーブルによって管理される。

## ページテーブル
<img width="1426" alt="スクリーンショット 2023-06-11 15 58 21" src="https://github.com/junyaU/os_study_memo/assets/61627945/58139aad-fce1-421c-b7ac-ddf8a1713bea">

ページテーブルは、ページをフレームにマッピングするために必要な情報を格納するテーブル。

x86_64のPML4ページングにおいては、
- **PML4** (Page Map Level 4)
- **PDPT** (Page Directory Pointer Table)
- **PD** (Page Directory)
- **PT** (Page Table)

の4階層のページテーブルを使用する。それぞれのテーブルは、512個のエントリからなり、1エントリは8バイト。\
それぞれのテーブルのエントリには、１階層下のテーブルの先頭アドレスと、そのテーブルの属性が格納されている。\
Page Tableのエントリには、ページに対応したフレームの先頭アドレスが格納されており、これがページに対応した物理アドレスとなる。\
PML4 Tableの先頭アドレスは、CR3レジスタから取得することができる。\
また、ページテーブルは物理アドレス空間に配置され、一つのページテーブルは512×8=4KiBのサイズを持つ。

このテーブルを元に、仮想アドレスから物理アドレスへの変換を行うため、実行するプロセスごとに、ページテーブルを用意し、実行前にページテーブルを切り替えておく必要がある。　\
CR3レジスタにページテーブルの先頭アドレスを格納することで、ページテーブルを切り替えることができる。プロセスの実行前にそのプロセスのページテーブルの先頭アドレスをCR3レジスタに格納するのは、OSの役割である。

対象の物理アドレスを見つけるために、どのエントリを参照していくかは、仮想アドレスを解釈することで決定する。

## アドレスの解釈
対象のエントリを参照するために、仮想アドレスを解釈する必要がある。\
今回は、**0xFFFF80001E141F3C**　という仮想アドレスを解釈することを例にする。

### カノニカルアドレス
x86_64の場合、仮想アドレスの63:48ビットは、仮想アドレスの符号拡張ビットとして扱われる。\
63:48ビットの全てのビットを47ビット目のビットで埋めないといけない。\
この制約を満たした仮想アドレスのことを、カノニカルアドレスと呼ぶ。カノニカルアドレスでなければCPUは例外を発生させる。

63:48ビットが全て1の場合にカノニカルアドレスは、
- **0xFFFF800000000000 ~ 0xFFFFFFFFFFFFFFFF**

の範囲となり、これは、負のカノニカルアドレスと呼ばれる。\
この空間は、カーネル空間と呼ばれ、一般にOSのカーネルが使用する。

全て0の場合、カノニカルアドレスは、
- **0x0000000000000000 ~ 0x00007FFFFFFFFFFF**

の範囲となり、これは、正のカノニカルアドレスと呼ばれる。\
この空間は、ユーザ空間と呼ばれ、一般にアプリなどのユーザプロセスが使用する。

この範囲外のアドレスは、カノニカルアドレスではないということになる。

例として出した、**0xFFFF80001E141F3C**は、負のカノニカルアドレスということになる。

## ページの属性
